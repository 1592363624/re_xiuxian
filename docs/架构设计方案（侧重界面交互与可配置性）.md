# 架构设计方案（侧重界面交互与可配置性）

# 一、整体架构分层设计（核心原则：解耦、可扩展、数据与逻辑分离）

采用“五层架构”设计，从下到上依次为：基础设施层、数据配置层、核心逻辑层、界面交互层、应用服务层。各层职责清晰，通过接口通信，确保修改配置数据或界面布局时不影响其他模块。

|架构分层|核心职责|关键模块|扩展/配置便利性设计|
|---|---|---|---|
|基础设施层|提供底层支撑能力，保障系统稳定运行|日志模块、网络模块、资源加载模块、热更新模块|热更新模块支持配置文件、界面资源的在线更新，无需重启服务器/客户端|
|数据配置层|统一管理所有可配置数据，实现数据与逻辑分离|配置加载模块、配置校验模块、配置缓存模块|采用“配置文件+可视化编辑器”模式，支持JSON/Excel格式配置，修改后实时生效|
|核心逻辑层|实现游戏核心玩法逻辑，不直接依赖具体配置数值|境界突破模块、战斗计算模块、年龄增长模块、资源交易模块|所有数值通过配置接口获取，修改配置不改动逻辑代码|
|界面交互层|负责界面展示与用户操作响应，与核心逻辑解耦|UI组件模块、界面路由模块、事件分发模块|界面布局通过配置文件定义，跳转规则集中管理，新增/修改界面无需改动逻辑|
|应用服务层|提供玩家可直接感知的功能入口，整合各层能力|主界面服务、角色管理服务、任务社交服务、修炼服务|服务模块可独立扩展，新增功能只需新增服务单元，不影响现有架构|
## 1.1 模块间通信机制（补充）

为确保各层、各模块解耦且通信高效，采用“同步接口+异步事件”双模式通信，明确通信协议与数据格式，避免直接依赖。

|通信模式|适用场景|实现方式|数据格式/协议|
|---|---|---|---|
|同步接口通信|实时性要求高、需即时返回结果的场景（如核心逻辑层获取配置数据、界面层获取玩家当前修为）|基于RESTful风格的内部接口，通过接口网关统一转发与权限校验|JSON格式，字段固定（含状态码、数据体、错误信息），示例：{"code":200,"data":{"修为":100},"msg":"success"}|
|异步事件通信|实时性要求低、无需即时返回的场景（如配置热更新通知、玩家突破成功广播、日志上报）|基于事件总线（EventBus）机制，模块注册事件监听，发送方发布事件后无需等待响应|事件JSON格式（含事件ID、触发模块、数据体、时间戳），示例：{"eventId":"ConfigHotUpdate","from":"ConfigLoadModule","data":{"configType":"RealmBreakthrough"},"timestamp":1699999999999}|
关键保障：接口网关统一记录通信日志，异常时触发告警；事件总线支持事件重试机制，避免因模块临时故障导致消息丢失。

# 二、界面交互架构设计（解决界面布局与点击跳转问题）

## 2.1 核心设计思路：组件化+路由化

将界面拆分为可复用组件，通过统一路由管理跳转逻辑，实现“布局可配置、跳转可管控、扩展可新增”的目标。

## 2.2 界面组件化设计

拆分通用组件与业务组件，组件独立封装，可跨界面复用，修改组件不影响其他模块。

|组件类型|包含组件|设计说明|
|---|---|---|
|通用组件|顶部信息栏、底部功能栏、弹窗组件、列表组件、进度条组件|通用组件通过配置文件定义样式和展示内容，如顶部信息栏可配置显示“角色名称、境界、气血”等字段，支持动态增减字段|
|业务组件|角色属性组件、修炼进度组件、任务列表组件、社交关系组件|业务组件依赖核心逻辑层接口获取数据，仅负责展示与交互，如角色属性组件通过“获取角色数据接口”获取修为、寿命等信息，无需关心数据计算逻辑|
## 

# 三、可配置系统架构设计（核心解决配置数据易修改问题）

## 3.1 核心设计思路：配置中心化+接口标准化

将所有可配置数据（初始数据、境界数据、材料数据等）集中存储在配置文件中，核心逻辑层通过标准化接口获取数据，实现“修改配置文件即可调整游戏数值，无需改动代码”。

## 3.2 配置数据分类与存储

按功能模块分类存储配置文件，每个分类对应独立的JSON文件，结构清晰，方便查找和修改。

## 3.3 配置加载与生效机制

通过“配置加载模块”实现配置文件的加载、缓存、校验与热更新，确保配置修改高效且安全。

1. 启动加载：游戏启动时，配置加载模块自动加载所有分类的配置文件，解析为内存中的数据对象，同时进行格式校验（如检查数值是否为正数、材料ID是否存在），校验失败则输出日志并使用默认配置

2. 缓存管理：加载后的配置数据存储在缓存中，核心逻辑层通过接口获取数据时，直接从缓存读取，提升性能

3. 热更新生效：修改配置文件后，通过“热更新接口”触发配置重新加载，无需重启服务器/客户端，新配置在10秒内全局生效；支持配置回滚，若修改后出现问题，可快速恢复至历史版本

## 3.4 标准化配置接口设计

核心逻辑层通过标准化接口获取配置数据，接口参数统一，返回格式固定，避免直接操作配置文件。

说明：新增配置数据时，只需新增对应的配置文件和接口；修改配置数据时，接口无需改动，仅需修改配置文件。

## 3.5 配置加载模块容错与监控设计（补充）

为避免配置加载异常影响游戏运行，新增容错机制与监控指标，保障模块稳定。

### 3.5.1 多层容错机制

1. 文件级容错：配置文件缺失/损坏时，自动从“备份配置目录”加载最近一次备份文件；备份文件也失效则加载默认配置（Default_XXX.json），同时触发邮件告警。

2. 字段级容错：配置文件字段缺失/格式错误时，跳过错误字段使用默认值（如修为上限缺失则默认1000），并在日志中详细标注错误字段位置，便于排查。

3. 网络级容错：若配置文件存储在云服务，网络中断时自动切换至本地缓存的配置文件，网络恢复后同步最新配置。

### 3.5.2 核心监控指标与告警

配置加载模块内置监控探针，实时采集以下指标，通过监控平台展示，异常时触发告警（邮件+钉钉）：

- 配置加载成功率：要求≥99.9%，低于阈值则告警（可能是文件损坏或网络问题）。

- 热更新成功率：要求≥99.5%，低于阈值则告警（可能是新配置格式错误）。

- 加载耗时：单类配置加载耗时≤500ms，总加载耗时≤3s（启动时），超时则告警（可能是配置文件过大）。

- 配置变更频率：记录每类配置的修改次数，异常高频修改（如1小时内≥10次）触发告警（可能是误操作）。

## 3.6 配置编辑工具（可视化辅助）

核心逻辑层通过标准化接口获取配置数据，接口参数统一，返回格式固定，避免直接操作配置文件。

说明：新增配置数据时，只需新增对应的配置文件和接口；修改配置数据时，接口无需改动，仅需修改配置文件。

## 3.5 配置编辑工具（可视化辅助）

为非开发人员设计可视化配置编辑工具，支持通过界面直接修改配置数据，自动校验格式并生成标准配置文件，降低修改门槛。

工具核心功能：

- 配置分类导航：按模块展示所有配置文件，点击即可进入编辑界面

- 可视化编辑：通过表单、下拉框、列表等组件编辑数据，如选择“境界ID”时下拉展示所有境界，无需手动输入

- 数据校验：实时校验输入数据的合理性（如修为不能为负数、材料数量需为整数），错误数据标红提示

- 版本管理：记录配置修改历史，支持一键回滚至任意历史版本

- 一键生效：编辑完成后点击“生效”按钮，自动同步配置文件并触发热更新，无需手动上传文件

## 3.6 数据存储方案细分（JSON vs 数据库）

核心设计原则：**静态配置数据用JSON存储，动态业务数据用数据库存储**，通过配置加载模块与数据访问层联动，确保数据一致性与访问效率，同时兼顾配置灵活性与数据持久化需求。

### 3.6.1 存储介质选型标准

- JSON存储适用场景：数据结构稳定、变更频率低（或需支持热更新）、无复杂查询需求的静态配置数据，核心优势是编辑便捷、支持热更新、适配配置加载模块的现有设计。

- 数据库存储适用场景：数据动态变化、需持久化存储、支持复杂查询/事务/关联查询的业务数据，核心优势是支持数据一致性校验、高并发访问、复杂条件筛选。

### 3.6.2 具体数据分类与存储介质对应表

|数据类型|存储介质|包含数据|设计说明|
|---|---|---|---|
|核心静态配置|JSON文件|角色初始配置、境界突破配置、功法法宝配置、年龄增长配置、资源产出配置、界面布局配置、路由跳转配置|对应原有`RoleInitConfig.json`等文件，统一放在配置目录，由配置加载模块加载校验，支持热更新|
|玩家动态数据|关系型数据库（MySQL）+ 缓存（Redis）|玩家基础信息（角色ID、名称、当前境界、当前年龄、当前修为）、背包物品数据、已学功法数据、任务进度数据、社交关系数据|MySQL存储完整数据，Redis缓存高频访问数据（如当前境界、修为），减轻数据库压力；玩家数据修改通过事务保证一致性|
|系统日志数据|关系型数据库（MySQL）|配置修改日志、玩家操作日志、热更新日志、异常报错日志|复用MySQL存储，通过合理表结构设计（加时间索引）支撑时间范围查询；无需额外部署时序数据库，简化部署运维，适配单人开发和低配服务器资源|
|临时交互数据|Redis缓存|玩家在线状态、秘境匹配队列、交易挂单临时数据、活动临时排名|数据时效性短，用Redis存储可提升访问速度，设置过期时间自动清理，减少存储冗余|
### 3.6.3 数据同步与校验机制

JSON配置与数据库数据存在关联时（如突破材料配置与玩家背包材料数据），需通过以下机制保证一致性：

1. 配置加载阶段：配置加载模块加载JSON配置（如突破材料）后，会联动数据访问层校验数据库中对应基础数据（如材料基础信息表）是否存在，缺失则触发告警并使用默认数据。

2. 业务运行阶段：玩家触发突破、使用道具等操作时，核心逻辑层先从配置加载模块获取最新JSON配置（如突破所需材料），再从数据库查询玩家当前数据（如背包材料数量），两者比对通过后才执行后续操作。

3. 热更新同步：JSON配置热更新后，配置加载模块会向核心逻辑层发送事件，核心逻辑层同步更新依赖该配置的业务逻辑（如突破条件变更），无需修改玩家数据库数据。

### 3.6.4 数据库选型补充建议

- 核心业务数据（玩家数据）：选用MySQL 8.0，支持事务、外键关联，成熟稳定，适配游戏业务的复杂查询需求（如查询玩家已完成的所有任务）。

- 缓存数据：选用Redis 6.x，支持多种数据结构（Hash、List、Sorted Set），可适配玩家背包、排名等多种场景，同时支持发布订阅机制，便于实现数据实时同步。

日志数据：复用MySQL存储，无需额外部署数据库，通过表结构优化（时间索引、JSON字段）适配日志的时序存储与查询需求，降低运维成本

## 3.7 架构安全设计（补充）

针对配置数据安全与玩家数据安全，新增多层安全防护机制，避免数据泄露或恶意篡改。

### 3.7.1 配置文件安全

- 文件加密：核心配置文件（如境界突破、功法属性）采用AES-256加密存储，配置加载模块加载时自动解密，避免明文泄露核心数值。

- 修改权限控制：配置编辑工具关联角色权限，仅“配置管理员”可修改核心配置，修改前需输入二次验证密码，修改后留存操作日志（含操作人员、时间、修改前后内容）。

- 防篡改校验：配置文件生成时附加MD5校验码，加载时校验文件MD5值，若不一致则判定为被篡改，拒绝加载并触发告警。

### 3.7.2 玩家数据安全

- 数据传输加密：玩家数据（如修为、背包物品）在客户端与服务器间传输时，采用HTTPS协议加密，避免中途被截取篡改。

- 数据库加密：MySQL中玩家核心数据字段（如角色ID、账号信息）采用加密存储，数据访问层查询时自动解密，防止数据库被入侵后数据泄露。

- 操作日志审计：记录玩家所有敏感操作（如突破境界、交易道具），日志不可篡改，便于后续追溯异常操作（如恶意刷道具）。

## 3.8 核心流程时序图（补充）

通过时序图清晰展示关键流程的模块交互逻辑，便于开发落地：

### 3.8.1 配置启动加载时序图

```Plain Text

sequenceDiagram
    系统启动模块->>配置加载模块: 发送启动加载指令
    配置加载模块->>环境配置模块: 获取当前环境（开发/测试/正式）
    环境配置模块-->>配置加载模块: 返回环境配置（配置文件路径）
    配置加载模块->>配置文件存储: 批量读取核心配置文件
    配置文件存储-->>配置加载模块: 返回配置文件流
    配置加载模块->>配置校验模块: 执行格式+联动校验
    配置校验模块-->>配置加载模块: 返回校验结果（通过/失败+错误信息）
    alt 校验通过
        配置加载模块->>配置缓存模块: 写入内存缓存
        配置缓存模块-->>配置加载模块: 缓存成功确认
        配置加载模块->>核心逻辑层: 发送配置加载完成事件
    else 校验失败
        配置加载模块->>备份配置目录: 加载备份/默认配置
        备份配置目录-->>配置加载模块: 返回备份配置
        配置加载模块->>日志模块: 上报校验失败日志+告警
        配置加载模块->>配置缓存模块: 写入备份配置至缓存
        配置加载模块->>核心逻辑层: 发送配置加载完成（降级）事件
    end
```

### 3.8.2 玩家境界突破时序图（关联配置与数据库）

```Plain Text

sequenceDiagram
    玩家客户端->>界面交互层: 点击“突破”按钮
    界面交互层->>UI路由模块: 发送跳转请求（功能ID:Breakthrough）
    UI路由模块->>核心逻辑层: 校验突破权限（修为/材料）
    核心逻辑层->>配置加载模块: 调用GetRealmBreakthroughData接口（当前境界ID）
    配置加载模块-->>核心逻辑层: 返回突破所需配置（修为/材料/寿命上限）
    核心逻辑层->>数据访问层: 查询玩家当前数据（修为/背包材料/年龄）
    数据访问层->>MySQL数据库: 读取玩家数据
    MySQL数据库-->>数据访问层: 返回玩家数据
    数据访问层-->>核心逻辑层: 返回玩家数据
    核心逻辑层->>核心逻辑层: 比对配置要求与玩家数据
    alt 满足突破条件
        核心逻辑层->>数据访问层: 执行突破数据更新（境界提升/材料扣除）
        数据访问层->>MySQL数据库: 事务更新玩家数据
        MySQL数据库-->>数据访问层: 更新成功
        数据访问层-->>核心逻辑层: 数据更新确认
        核心逻辑层->>事件总线: 发布突破成功事件
        事件总线->>配置加载模块: 同步更新玩家寿命上限（新境界配置）
        事件总线->>玩家客户端: 推送突破成功通知
    else 不满足条件
        核心逻辑层->>界面交互层: 返回不满足条件原因（如材料不足）
        界面交互层->>玩家客户端: 展示错误提示
    end
```

### 3.6.5 MySQL存储日志数据的适配方案（补充）

针对单人开发+Win2核4G服务器场景，优化日志表结构与配置，确保存储高效、查询流畅：

#### 1. 日志表结构设计（直接落地可用）

```sql

CREATE TABLE game_log (
  id INT AUTO_INCREMENT PRIMARY KEY,
  log_type VARCHAR(20) NOT NULL COMMENT '日志类型：config_update/player_operate/hot_update/error',
  module VARCHAR(30) NOT NULL COMMENT '所属模块：config_load/realm_breakthrough/ui_route',
  content JSON NOT NULL COMMENT '日志详情（配置修改前后/玩家操作内容/错误信息）',
  related_id VARCHAR(50) DEFAULT '' COMMENT '关联ID（玩家ID/配置ID）',
  create_time DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT '日志产生时间',
  INDEX idx_time_type (create_time, log_type) COMMENT '优化时间+类型查询'
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4;
```

# 四、架构扩展性保障设计

## 4.4 多服部署适配设计（补充）

为支持多服运营，架构需适配多服部署场景，确保配置统一管理、数据隔离：

- 配置中心统一管理：多服共享一个配置中心（如Nacos），核心配置文件存储在配置中心，各服务器启动时从配置中心拉取对应环境的配置，避免多服配置不一致。

- 配置差异化支持：支持按服务器维度配置差异化数值（如测试服突破难度降低、活动服资源产出提升），通过配置中心的“服务器标签”实现，无需修改配置文件结构。

#### 2. 资源优化配置（适配2核4G Win服务器）

设计说明：用JSON字段兼容不同类型日志的差异，无需建多张表；联合索引保障“按时间范围查某类日志”的核心需求。

- MySQL轻量配置：my.ini中设置innodb_buffer_pool_size=512M（占可用内存1/4）、max_connections=50（降低连接数），关闭二进制日志，减少资源占用

- 日志分级保留：核心日志（配置修改/错误日志）保留30天，普通操作日志保留7天，通过定时任务（如Windows任务计划程序）执行删除脚本，避免表过大

#### 3. 定时清理脚本示例（Windows批处理）

- 批量写入优化：日志采用批量插入模式（如每10条合并插入），降低数据库IO压力

```bat

:: 清理7天前的普通操作日志、30天前的核心日志
mysql -u root -p你的密码 -D 游戏数据库名 -e "DELETE FROM game_log WHERE log_type='player_operate' AND create_time < DATE_SUB(NOW(), INTERVAL 7 DAY);"
mysql -u root -p你的密码 -D 游戏数据库名 -e "DELETE FROM game_log WHERE log_type IN ('config_update','hot_update','error') AND create_time < DATE_SUB(NOW(), INTERVAL 30 DAY);"
```

- 数据隔离：各服务器使用独立的MySQL数据库实例，Redis按服务器划分数据库（如服1用DB1、服2用DB2），避免多服数据混淆；日志数据按服务器标签分类存储，便于单独查询。

## 4.1 模块解耦设计

## 4.1 模块解耦设计

各层、各模块之间通过接口通信，不直接依赖具体实现，新增或修改模块时不影响其他模块。例如：新增“化神期”境界时，只需在《RealmBreakthroughConfig.json》中添加化神期配置，核心逻辑层通过现有接口即可获取数据，无需修改突破逻辑代码。

## 4.2 预留扩展接口

在核心模块中预留扩展接口，支持后续新增功能。例如：在配置加载模块预留“第三方配置数据源接口”，后续可对接云配置服务；在界面路由模块预留“自定义跳转规则接口”，支持新增复杂的跳转逻辑。

## 4.3 多环境配置隔离

支持开发环境、测试环境、正式环境的配置隔离，不同环境使用独立的配置文件，避免测试配置影响正式服。例如：测试环境可将突破难度降低，正式环境使用正常配置，通过环境变量切换配置数据源。

# 五、实施步骤建议

1. 第一步：搭建基础设施层和数据配置层，完成配置加载模块、热更新模块的开发，定义核心配置文件格式

2. 第二步：开发界面交互层的UI组件模块和界面路由模块，完成核心界面（主界面、角色界面）的布局配置

3. 第三步：开发核心逻辑层，通过标准化接口获取配置数据，实现境界突破、年龄增长等核心玩法

4. 第四步：开发配置编辑工具，实现可视化配置修改和热更新功能

5. 第五步：测试配置修改流程和界面跳转功能，验证架构的可扩展性和可配置性
> （注：文档部分内容可能由 AI 生成）