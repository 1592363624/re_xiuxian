name: Deploy to Windows Server

on:
  push:
    branches: [ "main", "master" ]
  workflow_dispatch:

jobs:
  build-and-package:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'npm'
        cache-dependency-path: |
          client/package-lock.json
          server/package-lock.json

    # 1. 构建前端
    - name: Build Client
      run: |
        cd client
        npm ci
        npm run build
        echo "Frontend build complete."

    # 2. 准备发布包目录结构
    - name: Prepare Release Directory
      run: |
        mkdir -p release/client
        mkdir -p release/server
        
        # 复制前端构建产物
        cp -r client/dist release/client/
        
        # 复制后端代码 (排除 node_modules)
        cp -r server/* release/server/
        # 清理可能存在的 node_modules (以防万一)
        rm -rf release/server/node_modules
        
        # 复制启动脚本
        cp start-prod.bat release/
        
        # 创建 PM2 配置 (如果不存在)
        if [ ! -f server/ecosystem.config.js ]; then
          echo "module.exports = { apps: [{ name: 'xiuxian-server', script: './index.js', env: { PORT: 3000, NODE_ENV: 'production' } }] }" > release/server/ecosystem.config.js
        fi

    # 3. 上传构建产物 (可用于手动部署)
    - name: Upload Deployment Artifact
      uses: actions/upload-artifact@v4
      with:
        name: xiuxian-release
        path: release/

  # 4. 自动部署 (需要配置 GitHub Secrets)
  # 如果你配置了服务器的 SSH 信息，取消下面的注释即可启用自动部署
  deploy:
    needs: build-and-package
    runs-on: ubuntu-latest
    steps:
      - uses: actions/download-artifact@v4
        with:
          name: xiuxian-release
          path: .
  
      - name: Copy files via SCP
        uses: appleboy/scp-action@master
        with:
          host: ${{ secrets.HOST }}
          username: ${{ secrets.USERNAME }}
          password: ${{ secrets.PASSWORD }}
          source: "."
          target: "C:/Projects/re_xiuxian"
          # 关键修改：禁用 tar 打包，直接逐个传输文件
          # Windows 服务器上的 OpenSSH 有时处理 tar 解压有问题，特别是路径分隔符差异
          # 或者 tar 命令在 Windows 环境不可用/不兼容
          tar_tmp_path: "C:/Windows/Temp/" # 尝试指定一个确定的临时目录
          use_insecure_cipher: true # 兼容旧版加密算法（可选，视服务器配置）
          # rm: true # 传输前清空目标目录（慎用，如果目录不存在会报错）
  
      - name: Install Dependencies & Restart
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.HOST }}
          username: ${{ secrets.USERNAME }}
          password: ${{ secrets.PASSWORD }}
          script: |
            cd C:/Projects/re_xiuxian/server
            npm install --production
            # 推荐使用 PM2 管理进程
            npm install -g pm2
            pm2 startOrReload ecosystem.config.js
