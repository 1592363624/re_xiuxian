name: Deploy to Windows Server

on:
  push:
    branches: [ "main", "master" ]
  workflow_dispatch:

jobs:
  build-and-package:
    runs-on: ubuntu-latest
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'npm'
        cache-dependency-path: |
          client/package-lock.json
          server/package-lock.json

    # 1. 构建前端
    - name: Build Client
      run: |
        cd client
        npm ci
        npm run build
        echo "Frontend build complete."

    # 2. 准备发布包目录结构
    - name: Prepare Release Directory
      run: |
        mkdir -p release/client
        mkdir -p release/server
        
        # 复制前端构建产物
        cp -r client/dist release/client/
        
        # 复制后端代码 (排除 node_modules)
        cp -r server/* release/server/
        rm -rf release/server/node_modules
        
        # 复制启动脚本
        cp start-prod.bat release/
        
        # 创建 PM2 配置 (写入生产环境数据库配置)
        # 敏感信息通过 GitHub Secrets 注入，避免明文硬编码
        echo "module.exports = {
          apps: [{
            name: 'xiuxian-server',
            script: './index.js',
            env: {
              PORT: 3000,
              NODE_ENV: 'production',
              DB_HOST: '${{ secrets.DB_HOST }}',
              DB_USER: '${{ secrets.DB_USER }}',
              DB_PASS: '${{ secrets.DB_PASS }}',
              DB_NAME: '${{ secrets.DB_USER }}',
              DB_DIALECT: 'mysql'
            }
          }]
        }" > release/server/ecosystem.config.js

    # 3. 上传构建产物 (可用于手动部署)
    - name: Upload Deployment Artifact
      uses: actions/upload-artifact@v4
      with:
        name: xiuxian-release
        path: release/

  # 4. 自动部署
  deploy:
    needs: build-and-package
    runs-on: ubuntu-latest
    steps:
      - name: Download build artifact
        uses: actions/download-artifact@v4
        with:
          name: xiuxian-release
          path: release

      # 打包为单个压缩包 (打包到上级目录，避免包含自身和路径问题)
      - name: Compress Release Package
        run: |
          cd release
          tar -czf ../deploy_package.tar.gz .

      # 步骤1：先创建Windows临时目录
      - name: Create Temp Directory on Windows
        uses: appleboy/ssh-action@v1.0.0
        with:
          host: ${{ secrets.HOST }}
          username: ${{ secrets.USERNAME }}
          password: ${{ secrets.PASSWORD }}
          port: 22
          script: |
            powershell -Command "New-Item -Path 'C:\\Projects\\re_xiuxian_temp' -ItemType Directory -Force"

      # 步骤2：SCP传输压缩包
      - name: Copy Package to Windows via SCP
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ secrets.HOST }}
          username: ${{ secrets.USERNAME }}
          password: ${{ secrets.PASSWORD }}
          port: 22
          source: "deploy_package.tar.gz"
          target: "C:\\Projects\\re_xiuxian_temp"
          debug: true

      # 步骤3：在Windows服务器解压并部署
      - name: Deploy on Windows Server
        uses: appleboy/ssh-action@v1.0.0
        with:
          host: ${{ secrets.HOST }}
          username: ${{ secrets.USERNAME }}
          password: ${{ secrets.PASSWORD }}
          port: 22
          script: |
            powershell -Command "
              \$ErrorActionPreference = 'Stop'  # 遇到错误立即停止
              
              # 1. 确保目标目录存在
              if (-not (Test-Path 'C:\\Projects\\re_xiuxian')) {
                New-Item -Path 'C:\\Projects\\re_xiuxian' -ItemType Directory -Force | Out-Null
                Write-Host 'Created target directory: C:\\Projects\\re_xiuxian'
              }
              
              # 2. 解压压缩包 (注意：压缩包现在位于 temp 根目录)
              Write-Host 'Extracting deployment package...'
              tar -xzf 'C:\\Projects\\re_xiuxian_temp\\deploy_package.tar.gz' -C 'C:\\Projects\\re_xiuxian'
              
              # 3. 清理临时文件/目录
              Write-Host 'Cleaning up temp files...'
              Remove-Item 'C:\\Projects\\re_xiuxian_temp' -Recurse -Force
              
              # 4. 安装后端依赖
              Write-Host 'Installing server dependencies...'
              Set-Location 'C:\\Projects\\re_xiuxian\\server'
              npm install --production
              
              # 5. 安装PM2 (如果未安装) 并重启服务
              if (-not (Get-Command pm2 -ErrorAction SilentlyContinue)) {
                Write-Host 'Installing PM2 globally...'
                npm install -g pm2
              }
              
              Write-Host 'Starting/Restarting PM2 service...'
              pm2 startOrReload ecosystem.config.js
              pm2 save
              
              Write-Host 'Deployment completed successfully!'
            "
            "