name: Deploy to Windows Server

on:
  push:
    branches: [ "main", "master" ]
  workflow_dispatch:

jobs:
  build-and-package:
    runs-on: ubuntu-latest
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'npm'
        cache-dependency-path: |
          client/package-lock.json
          server/package-lock.json

    # 1. 构建前端
    - name: Build Client
      run: |
        cd client
        npm ci
        npm run build
        echo "Frontend build complete."

    # 2. 准备发布包目录结构
    - name: Prepare Release Directory
      run: |
        mkdir -p release/client
        mkdir -p release/server
        
        # 复制前端构建产物
        cp -r client/dist release/client/
        
        # 复制后端代码 (排除 node_modules)
        cp -r server/* release/server/
        rm -rf release/server/node_modules
        
        # 复制启动脚本
        cp start-prod.bat release/
        
        # 创建 PM2 配置 (如果不存在)
        if [ ! -f server/ecosystem.config.js ]; then
          echo "module.exports = { apps: [{ name: 'xiuxian-server', script: './index.js', env: { PORT: 3000, NODE_ENV: 'production' } }] }" > release/server/ecosystem.config.js
        fi

    # 3. 上传构建产物 (可用于手动部署)
    - name: Upload Deployment Artifact
      uses: actions/upload-artifact@v4
      with:
        name: xiuxian-release
        path: release/

  # 4. 自动部署
  deploy:
    needs: build-and-package
    runs-on: ubuntu-latest
    steps:
      - name: Download build artifact
        uses: actions/download-artifact@v4
        with:
          name: xiuxian-release
          path: release

      # 打包为单个压缩包，减少传输文件数
      - name: Compress Release Package
        run: |
          cd release
          tar -czf deploy_package.tar.gz *

      # 步骤1：先创建Windows临时目录（避免scp传输时目录不存在）
      - name: Create Temp Directory on Windows
        uses: appleboy/ssh-action@v1.0.0
        with:
          host: ${{ secrets.HOST }}
          username: ${{ secrets.USERNAME }}
          password: ${{ secrets.PASSWORD }}
          port: 22
          script: |
            powershell -Command "New-Item -Path 'C:\\Projects\\re_xiuxian_temp' -ItemType Directory -Force"

      # 步骤2：SCP传输压缩包（关键：路径用双反斜杠，版本用最新）
      - name: Copy Package to Windows via SCP
        uses: appleboy/scp-action@v0.1.7  # 替换为稳定版，放弃master
        with:
          host: ${{ secrets.HOST }}
          username: ${{ secrets.USERNAME }}
          password: ${{ secrets.PASSWORD }}
          port: 22
          source: "release/deploy_package.tar.gz"
          target: "C:\\Projects\\re_xiuxian_temp"  # 双反斜杠适配Windows
          debug: true  # 开启调试，方便排查问题（部署稳定后可关闭）

      # 步骤3：在Windows服务器解压并部署（统一用PowerShell语法）
      - name: Deploy on Windows Server
        uses: appleboy/ssh-action@v1.0.0
        with:
          host: ${{ secrets.HOST }}
          username: ${{ secrets.USERNAME }}
          password: ${{ secrets.PASSWORD }}
          port: 22
          script: |
            powershell -Command "
              # 1. 确保目标目录存在
              if (-not (Test-Path 'C:\\Projects\\re_xiuxian')) {
                New-Item -Path 'C:\\Projects\\re_xiuxian' -ItemType Directory -Force | Out-Null
                Write-Host 'Created target directory: C:\\Projects\\re_xiuxian'
              }
              
              # 2. 解压压缩包（Windows自带tar，兼容Win10/Server2019+）
              Write-Host 'Extracting deployment package...'
              tar -xzf 'C:\\Projects\\re_xiuxian_temp\\deploy_package.tar.gz' -C 'C:\\Projects\\re_xiuxian'
              
              # 3. 清理临时文件/目录
              Write-Host 'Cleaning up temp files...'
              Remove-Item 'C:\\Projects\\re_xiuxian_temp\\deploy_package.tar.gz' -Force
              Remove-Item 'C:\\Projects\\re_xiuxian_temp' -Recurse -Force
              
              # 4. 安装后端依赖（生产环境）
              Write-Host 'Installing server dependencies...'
              Set-Location 'C:\\Projects\\re_xiuxian\\server'
              npm install --production
              
              # 5. 安装PM2并重启服务
              Write-Host 'Starting/Restarting PM2 service...'
              npm install -g pm2
              pm2 startOrReload ecosystem.config.js
              pm2 save  # 保存PM2进程列表，重启服务器后自动恢复
              
              Write-Host 'Deployment completed successfully!'
            "