name: Deploy to Windows Server

on:
  push:
    branches: [ "main", "master" ]
  workflow_dispatch:

jobs:
  build-and-package:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'npm'
        cache-dependency-path: |
          client/package-lock.json
          server/package-lock.json

    # 1. 构建前端
    - name: Build Client
      run: |
        cd client
        npm ci
        npm run build
        echo "Frontend build complete."

    # 2. 准备发布包目录结构
    - name: Prepare Release Directory
      run: |
        mkdir -p release/client
        mkdir -p release/server
        
        # 复制前端构建产物
        cp -r client/dist release/client/
        
        # 复制后端代码 (排除 node_modules)
        cp -r server/* release/server/
        # 清理可能存在的 node_modules (以防万一)
        rm -rf release/server/node_modules
        
        # 复制启动脚本
        cp start-prod.bat release/
        
        # 创建 PM2 配置 (如果不存在)
        if [ ! -f server/ecosystem.config.js ]; then
          echo "module.exports = { apps: [{ name: 'xiuxian-server', script: './index.js', env: { PORT: 3000, NODE_ENV: 'production' } }] }" > release/server/ecosystem.config.js
        fi

    # 3. 上传构建产物 (可用于手动部署)
    - name: Upload Deployment Artifact
      uses: actions/upload-artifact@v4
      with:
        name: xiuxian-release
        path: release/

  # 4. 自动部署 (需要配置 GitHub Secrets)
  # 如果你配置了服务器的 SSH 信息，取消下面的注释即可启用自动部署
  deploy:
    needs: build-and-package
    runs-on: ubuntu-latest
    steps:
      - uses: actions/download-artifact@v4
        with:
          name: xiuxian-release
          path: release

      # 方案 B: 使用 tar 打包传输单个文件，然后在服务器端解压
      # 这样可以避免 drone-scp 尝试在 Windows 上自动执行 tar 导致的路径问题
      - name: Compress Release
        run: |
          cd release
          tar -czf deploy_package.tar.gz *

      - name: Copy package via SCP
        uses: appleboy/scp-action@master
        with:
          host: ${{ secrets.HOST }}
          username: ${{ secrets.USERNAME }}
          password: ${{ secrets.PASSWORD }}
          source: "release/deploy_package.tar.gz"
          target: "C:/Projects/re_xiuxian_temp"
          strip_components: 1 # 去掉 release/ 这一层目录
          
      - name: Deploy on Server
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.HOST }}
          username: ${{ secrets.USERNAME }}
          password: ${{ secrets.PASSWORD }}
          script: |
            # 切换到 PowerShell 模式
            powershell -Command "Write-Host 'Starting deployment...'"
            
            # 1. 确保目标目录存在
            if not exist C:\Projects\re_xiuxian mkdir C:\Projects\re_xiuxian
            
            # 2. 解压文件 (使用 Windows 自带的 tar，Windows 10/Server 2019+ 自带)
            echo Extracting files...
            tar -xzf C:\Projects\re_xiuxian_temp\deploy_package.tar.gz -C C:\Projects\re_xiuxian
            
            # 3. 清理临时文件
            del C:\Projects\re_xiuxian_temp\deploy_package.tar.gz
            rmdir C:\Projects\re_xiuxian_temp
            
            # 4. 安装依赖并启动
            cd C:\Projects\re_xiuxian\server
            call npm install --production
            call npm install -g pm2
            pm2 startOrReload ecosystem.config.js
